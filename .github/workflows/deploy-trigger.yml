name: Deploy Trigger

on:
  # Trigger when individual pipelines complete successfully
  workflow_run:
    workflows: ["Quality Checks", "Security Checks", "Build Pipeline"]
    types:
      - completed
    branches: [main]

permissions:
  contents: read
  pages: write
  id-token: write
  actions: read

jobs:
  check-and-deploy:
    name: Check All Pipelines and Deploy
    runs-on: ubuntu-latest
    # Only run if the triggering workflow succeeded
    if: github.event.workflow_run.conclusion == 'success'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get commit details
        id: commit-details
        run: |
          COMMIT_SHA="${{ github.event.workflow_run.head_sha }}"
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "ðŸ” Checking all pipelines for commit: $COMMIT_SHA"

      - name: Check all pipeline status
        id: pipeline-status
        run: |
          COMMIT_SHA="${{ steps.commit-details.outputs.commit_sha }}"
          
          echo "ðŸ” Checking pipeline status for commit: $COMMIT_SHA"
          
          # Get workflow runs for this commit and extract status
          QUALITY_STATUS=$(gh api repos/${{ github.repository }}/actions/runs --jq ".workflow_runs[] | select(.head_sha == \"$COMMIT_SHA\" and .name == \"Quality Checks\") | .conclusion" | head -1)
          SECURITY_STATUS=$(gh api repos/${{ github.repository }}/actions/runs --jq ".workflow_runs[] | select(.head_sha == \"$COMMIT_SHA\" and .name == \"Security Checks\") | .conclusion" | head -1)
          BUILD_STATUS=$(gh api repos/${{ github.repository }}/actions/runs --jq ".workflow_runs[] | select(.head_sha == \"$COMMIT_SHA\" and .name == \"Build Pipeline\") | .conclusion" | head -1)
          
          echo "quality_status=${QUALITY_STATUS:-unknown}" >> $GITHUB_OUTPUT
          echo "security_status=${SECURITY_STATUS:-unknown}" >> $GITHUB_OUTPUT
          echo "build_status=${BUILD_STATUS:-unknown}" >> $GITHUB_OUTPUT
          
          echo "ðŸ“Š Pipeline Status Summary:"
          echo "- Quality: ${QUALITY_STATUS:-unknown}"
          echo "- Security: ${SECURITY_STATUS:-unknown}"
          echo "- Build: ${BUILD_STATUS:-unknown}"
          
          # Check if all required pipelines succeeded
          if [[ "$QUALITY_STATUS" == "success" && "$SECURITY_STATUS" == "success" && "$BUILD_STATUS" == "success" ]]; then
            echo "all_pipelines_success=true" >> $GITHUB_OUTPUT
            echo "âœ… All pipelines succeeded - ready for deployment"
          else
            echo "all_pipelines_success=false" >> $GITHUB_OUTPUT
            echo "â³ Not all pipelines completed successfully yet"
            echo "Deployment will wait for all pipelines to succeed"
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Trigger deployment
        if: steps.pipeline-status.outputs.all_pipelines_success == 'true'
        run: |
          echo "ðŸš€ All pipelines succeeded - triggering deployment"
          curl -X POST \
            -H "Authorization: token ${{ github.token }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/dispatches \
            -d '{
              "event_type": "deploy-ready",
              "client_payload": {
                "commit_sha": "${{ steps.commit-details.outputs.commit_sha }}",
                "artifact_name": "build-files-${{ steps.commit-details.outputs.commit_sha }}",
                "quality_status": "${{ steps.pipeline-status.outputs.quality_status }}",
                "security_status": "${{ steps.pipeline-status.outputs.security_status }}",
                "build_status": "${{ steps.pipeline-status.outputs.build_status }}"
              }
            }'
          echo "âœ… Deployment event dispatched"

      - name: Deployment summary
        if: always()
        run: |
          echo "## ðŸš€ DEPLOY TRIGGER - SUMMARY" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event.workflow_run.name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ steps.commit-details.outputs.commit_sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.event.workflow_run.head_branch }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Pipeline Gate Status" >> $GITHUB_STEP_SUMMARY
          echo "| Pipeline | Status | Required | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Quality | ${{ steps.pipeline-status.outputs.quality_status }} | âœ… Success | ${{ steps.pipeline-status.outputs.quality_status == 'success' && 'âœ… PASS' || 'âŒ FAIL' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ steps.pipeline-status.outputs.security_status }} | âœ… Success | ${{ steps.pipeline-status.outputs.security_status == 'success' && 'âœ… PASS' || 'âŒ FAIL' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ steps.pipeline-status.outputs.build_status }} | âœ… Success | ${{ steps.pipeline-status.outputs.build_status == 'success' && 'âœ… PASS' || 'âŒ FAIL' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ steps.pipeline-status.outputs.all_pipelines_success }}" == "true" ]]; then
            echo "### âœ… DEPLOYMENT: TRIGGERED" >> $GITHUB_STEP_SUMMARY
            echo "All quality gates passed - deployment initiated" >> $GITHUB_STEP_SUMMARY
          else
            echo "### â³ DEPLOYMENT: WAITING" >> $GITHUB_STEP_SUMMARY
            echo "Waiting for all pipelines to complete successfully" >> $GITHUB_STEP_SUMMARY
          fi